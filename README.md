# QoS-for-Home
Различные QoS настройки для домашнего использования.<br>
Информация тут рассчитана на пользователя средней подготовки.<br>
Новичкам будет сложно, а профессионалам скучно.<br>

# Цель настроек.

Автоматизировать управление трафиком, чтобы важный трафик (игры, VOIP, DNS) не вытеснялся торрентами, обновлениями т.д., и при этом мог нормально работать браузер - не заикался просмотр видео, стримов и сам серфинг.

# Как это работает.
&nbsp;&nbsp;&nbsp;&nbsp;Это работает в связке "операционная система + роутер".<br>
&nbsp;&nbsp;&nbsp;&nbsp;Первоначально в Windows типы трафика помечаются DSCP метками в зависимости от приложения (это нужно сделать на каждой машине, которая находится в LAN), а потом на роутере Mikrotik в Mangle просеиваем поэтапно трафик, учитывая наши метки, протоколы и порты - тепер в роутере есть информация что это за трафик.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Первыми в Mangle стоят правила, которые обрабатывают самый обьемный трафик - закачки и браузер, этот трафик дальше не будет обрабатываться.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Для облегчения обработки первых пакетов, пока трафик еще не отсортирован, маркировка соединений вынесена в отдельную цепочку, на которую выполняется джамп в начале.
Трафик сортируется на типы - Download, Browser, OBS, IPCALL (Аудио-Водео звонки), NetServ (сетевые сервисы), Router (сервисы самого роутера как устройства) и no-mark (весь остальной трафик).<br>
Отсортированный трафик отправляется в очереди с шейперами. <br>
&nbsp;&nbsp;&nbsp;&nbsp;Максимальные скорости для шейперов нужно настроить индивидуально, в зависимости от тарифа/скорости физического порта.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Queue Type для Mikrotik установлен стандартный для совместимости. Меняйте на то, что считаете нужным и с чем справится роутер.<br>
Mangle правила в моей схеме оптимизированны настолько, на сколько это возможно. Как мне кажется.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Еще упростить и облегчить этот QoS можно только путем обьединения типов трафика в одинг тип, например игровой + VOIP, но усилия не стоят результата, ибо в первую очередь из обработки в Mangle убирается самый тяжелый трафик - это закачки и браузер, а на игровой и VIOP трафик приходится ничтожно мало пакетов и объема.<br>

# Как это установить?

1. Через PowerShell внести в Windows параметры  DSCP маркировки трафика от приложений. Не обязательно запускать сам ps1, можно просто скопировать и вставить содержимое файлов в терминал.<br>
2. На роутере импоритровать 2 файла конфига или вставить содержимое через терминал на роутере. Разумеется Mangle и все Queue должны быть предварительно очищены от ваших настроек.<br>
<br>
Схема рассчитана на стандартную домашнюю конфигурацию, где WAN это ether1, а все клиенты находятся в едином бридже. Усли у вас WAN  это не ether1, то замените на ваш вариант в Mangle во всех правилах, где указан ether1. <br>

# FAQ

Q: Для какого это роутера Mikrotik?<br>
A: Создавалось это для АС2 для ROS 7.12. Возможно будет работать и на ROS 6.xx. Не проверял.<br>

Q: А на HEX будет работать?<br>
A: Будет, но скорее всего этот роутер больше 150Мбит/с не потянет, а может и меньше.<br>

Q: А это совместимо с FastTrack?<br>
A: Конечно нет, FastTrack нужно отключать.<br>

Q: Почему именно такая мудреная схема из связки ОС+роутер?<br>
A: Потому что возможности ротуера по CPU не безграничны, а из-за HTTPS/443 парктически невозможно дешево отличить поток одного приложения от другого.<br>

Q: А зачем всё так сложно? Вот я включил в Simple Queue планировшик CAKE и вроде всё нормально!<br>
A: Не всё так просто. Если CAKE не будет знать о типе трафика, то он не пожалеет и дропнет пакеты тафика, которые критически важны, например голосовой связи или игры. А если трафик отсортировать, то и нагрузка растет, да и надобность в CAKE снижается, ведь приоритеты и пределы уже можно расставить руками и незачем тратить ресурсы CPU на CAKE.<br>

Q: CAKE очень тяжелый, а я хочу чтобы было получше, чем стандартный FIFO!<br>
A: Рекомендую попробовать SFQ.<br>

Q: А почему в списке приложений нет назначения меток для Discord/ZOOM?<br>
A: У них есть собственная функциональность назначения меток, в частности у Discord в настройках есть опция использования пакетов с высоким приоритетом обслуживания, которую надо включить, и Discord сам пометит меткой 40 голосовой трафик. Отмечать приложение целиком через ОС плохая идея, потому что все котики и мемасы будут помечены высокоприоритетными метками, а это будет мешать остальным более важным типам трафика.<br>

Q: Я пользуюсь приложениями, которых нет в списке назначения меток, что делать?<br>
A: Добавлять их в список, по аналогии. Магазины к магазинам, игры к играм, указывая метку для это типа. Если приложение по типу ну никак не вписывается в схему, то придется вводить и новый тип трафика в схему сортировки и очередей на роутере. Это уже сложнее. Эта схема создана с прицелом на обычный домашний развлекательный ПК.<br>

Q: А в WIndows 7/8 будет работать?<br>
A: Это не тестировалось, но возможно будет. Скорее всего потребуется создание ключа "Do not use NLA" в реестре, а как внести правила уже ищите и проверсяйте сами. Учтите, что этот ключ может понижать уровень безопасности в OC, если к этой машине используется доступ по RDP.<br>

Q: Это работает во всех версиях Windows 10+/11?<br>
A: Как минимум с версии Win10 21h1 и на всех Win11. <br>

Q: Хочу управлять метками в Windows через GUI!<br>
A: Такое тоже возможно, через Group Policy. Но тогда все правила придется долго и муторно вносить руками через интерфейс, либо переписывать сначала все правила в скрипте, именив NetworkProfile с ALL на Domain (вроде бы так). Однако, до версии примерно Win 10 21h1, требовалось еще и создание в реестре включа "Do not use NLA", как в Win7, а этот ключ вроде как снижал безопасность ОС, если к этой машине пользуются доступом по RDP. Позже надобность наличия ключа изменили и теперь создавать ключ не требуется.<br>

Q: А есть всё тоже самое, но для OpenWRT/Linux?<br>
A: Пока нет, возможно будет, когда-нибудь...если мне понадобится такое создать.<br>

Q: У меня много Andriod устройств, что делать с ними? <br>
A: Пока ничего с ними не сделать. Их трафик будет сортироватья по портам, как Browser и NetServ. Доступ к DSCP разметке трафика есть только у root или у самого приложения, если его разработчик это предусмотрел. А рутовать смарты и TV приставки дело небезопасное. <br>
