# QoS-for-Home<br>
Различные QoS настройки для домашнего использования.<br>
Информация тут рассчитана на пользователя средней подготовки.<br>
Новичкам будет сложно, а профессионалам скучно.<br>

# Цель настроек.

Автоматизировать управление трафиком, чтобы важный трафик (игры, VOIP, DNS) не вытеснялся торрентами, обновлениями и т.д., и при этом мог нормально работать браузер - не заикался просмотр видео, стримов и сам серфинг.<br>

# Как это работает.
Это работает в связке «операционная система + роутер».<br>
Первоначально в Windows типы трафика помечаются DSCP метками в зависимости от приложения (это нужно сделать на каждой машине, которая находится в LAN), а потом на роутере Mikrotik в Mangle просеиваем поэтапно трафик, учитывая наши метки, протоколы и порты - теперь в роутере есть информация, что это за трафик.<br>
Первыми в Mangle стоят правила, которые обрабатывают самый объемный трафик - закачки и браузер, этот трафик дальше не будет обрабатываться.<br>
Для облегчения обработки первых пакетов, пока трафик еще не отсортирован, маркировка соединений вынесена в отдельную цепочку, на которую выполняется джамп в начале.
Трафик сортируется на типы - Download, Browser, OBS, IPCALL (Аудио-Видео звонки), NetServ (сетевые сервисы), Router (сервисы самого роутера как устройства) и no-mark (весь остальной трафик).<br>
Отсортированный трафик отправляется в очереди с шейперами.<br>
Максимальные скорости для шейперов нужно настроить индивидуально, в зависимости от тарифа/скорости физического порта.<br>
Queue Type для Mikrotik установлен стандартный для совместимости. Меняйте на то, что считаете нужным и с чем справится роутер.<br>
Mangle правила в моей схеме оптимизированы настолько, насколько это возможно. Как мне кажется.<br>
Еще упростить и облегчить этот QoS можно только путем объединения типов трафика в один тип, например игровой + VOIP, но усилия не стоят результата, ибо в первую очередь из обработки в Mangle убирается самый тяжелый трафик - это закачки и браузер, а на игровой и VOIP трафик приходится ничтожно мало пакетов и объема.<br>

# Как это установить?

1. Через PowerShell внести в Windows параметры DSCP маркировки трафика от приложений. Не обязательно запускать сам QoSv2.ps1, можно просто скопировать и вставить содержимое файлов в терминал.<br>
2. На роутере импортировать 2 файла конфига или вставить их содержимое через терминал на роутере. Разумеется, Mangle и все Queue должны быть предварительно очищены от ваших настроек.<br>
3. Схема рассчитана на стандартную домашнюю конфигурацию, где WAN — это ether1, а все клиенты находятся в едином бридже. Если у вас WAN — это не ether1, то замените на ваш вариант в Mangle во всех правилах, где указан ether1.<br>
4. Кроме этого, в директории по пути Windows 10+/Qos_Manager имеется скрипт QoS-Managerv01.ps1. Это GUI менеждер для QoS на PowerShell. Работает примитивно, уверен вы легко разберетесь. Он написан AI LLM-кой (потому что я не умею), под капотом там наверняка кривовато, но оно работает как и было задумано. Загляните в CSV в этой же директори и вы поймете куда что вписывать в интерфейсе менеджера.<br>

# FAQ

Q: Для какого это роутера Mikrotik?<br>
A: Создавалось это для АС2 для ROS 7.12. Возможно, будет работать и на ROS 6.xx. Не проверял.<br>

Q: А на HEX будет работать?<br>
A: Будет, но, скорее всего, этот роутер больше 150 Мбит/с не потянет, а может и меньше.<br>

Q: А это совместимо с FastTrack?<br>
A: Конечно нет, FastTrack нужно отключать.<br>

Q: Почему именно такая мудреная схема из связки ОС+ роутер?<br>
A: Потому что возможности роутера по CPU не безграничны, а из-за HTTPS/443 практически невозможно дешево отличить поток одного приложения от другого.<br>

Q: А зачем в Mangle повторно к пакетам применяется назначение меток DSCP?<br>
A: Это помогает работе Wi-Fi в домашней сети, чипы Wi-Fi умные и умеют сами смотреть на метки DSCP и дополнительно оптимизировать передачу пакетов в эфире, если у Wi-Fi роутера включена функция WMM. Проставление метки DSCP — недорогая операция.<br>

Q: А зачем всё так сложно? Вот я включил в Simple Queue планировщик CAKE и вроде всё нормально!<br>
A: Не всё так просто. Если CAKE не будет знать о типе трафика, то он не пожалеет и дропнет пакеты трафика, которые критически важны, например голосовой связи или игры. А если трафик отсортировать, то и нагрузка растет, да и надобность в CAKE снижается, ведь приоритеты и пределы уже можно расставить руками и незачем тратить ресурсы CPU на CAKE.<br>

Q: CAKE очень тяжелый, а я хочу, чтобы было получше, чем стандартный FIFO!<br>
A: Рекомендую попробовать SFQ.<br>

Q: А почему в списке приложений нет назначения меток для Discord/ZOOM?<br>
A: У них есть собственная функциональность назначения меток, в частности у Discord в настройках есть опция использования пакетов с высоким приоритетом обслуживания, которую надо включить, и Discord сам пометит меткой 40 голосовой трафик. Отмечать приложение целиком через ОС — плохая идея, потому что все котики и мемасы будут помечены высокоприоритетными метками, а это будет мешать остальным, более важным типам трафика.<br>

Q: Я пользуюсь приложениями, которых нет в списке назначения меток, что делать?<br>
A: Добавлять их в список по аналогии. Магазины к магазинам, игры к играм, указывая метку для этого типа. Если приложение по типу ну никак не вписывается в схему, то придется вводить и новый тип трафика в схему сортировки и очередей на роутере. Это уже сложнее. Эта схема создана с прицелом на обычный домашний развлекательный ПК.<br>

Q: А в Windows 7/8 будет работать?<br>
A: Это не тестировалось, но, возможно, будет. Скорее всего, потребуется создание ключа «Do not use NLA» в реестре, а как внести правила, уже ищите и проверяйте сами. Учтите, что этот ключ может понижать уровень безопасности в ОС, если к этой машине используется доступ по RDP.<br>

Q: Это работает во всех версиях Windows 10+/11?<br>
A: Как минимум с версии Win10 21h1 и на всех Win11.<br>

Q: Хочу управлять метками в Windows через GUI!<br>
A: Я тоже захотел и AI мне наговнокодил QoS Manager на powershell. Найдете в директории Windows 10+/Qos_Manager. Под капотом скорее всего ужас, но оно работает и делает что нужно.<br>
  Еще через интерфес возможно управлять в Group Policy. Но тогда все правила придется долго и муторно вносить руками через интерфейс, либо переписывать сначала все правила в скрипте, изменив NetworkProfile с ALL на Domain (вроде бы так). Однако до версии примерно Win 10 21h1 требовалось еще и создание в реестре ключа «Do not use NLA», как в Win7, а этот ключ вроде как снижал безопасность ОС, если к этой машине пользуются доступом по RDP. Позже надобность наличия ключа изменили, и теперь создавать ключ не требуется.<br>

Q: А есть всё тоже самое, но для OpenWRT/Linux?<br>
A: Пока нет, возможно будет когда-нибудь...если мне понадобится такое создать.<br>

Q: У меня много Android-устройств, что делать с ними?<br>
A: Пока ничего с ними не сделать. Их трафик будет сортироваться по портам, как Browser и NetServ. Доступ к DSCP разметке трафика есть только у root или у самого приложения, если его разработчик это предусмотрел. А рутовать смарты и TV приставки — дело небезопасное. <br>
